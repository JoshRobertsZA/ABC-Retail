@model List<CLDV6212POE.Models.Product>

@{
    ViewData["Title"] = "Product Information";
    var userRole = Context.Session.GetString("UserRole");
}

<div class="product">
    <div class="product-container">

        <!-- Search Bar -->
        <div class="search-section">
            <div class="container">
                <div class="search-box">
                    <input id="searchInput" type="text" 
                           placeholder="Search for products, brands..." 
                           value="@ViewData["SearchQuery"]" />
                    <button><i class="fa fa-search"></i></button>
                </div>
            </div>
        </div>

        <!-- Filter -->
        <div class="filter-section">
            <div class="filter-container">
                <p class="filter-text"></p>

                <div class="filter-right">
                    <div class="filter-sort-group">
                        <span class="filter-sort-text">Sort By:</span>
                        <select id="sortSelect" class="filter-select">
                            <option value="all">All</option>
                            <option value="hightolow">Price: High to Low</option>
                            <option value="lowtohigh">Price: Low to High</option>
                        </select>

                    </div>

                    @if (userRole == "Admin")
                    {
                        <a asp-controller="Product" asp-action="Add" class="add-product-btn">
                            + Add Product
                        </a>
                    }
                </div>
            </div>
        </div>
        
        <div id="productContainer">
            @Html.Partial("_ProductListPartial", Model)
        </div>

        <!-- Footer -->
        <div class="footer-container">
            <footer class="footer-text">
                <p class="footer-main">&copy; 2025 ABC Retail</p>
                <p class="footer-sub">Built by <span>Josh Roberts</span></p>
            </footer>
        </div>

    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById("productContainer");

    function openProductModal(rowKey) {
        fetch(`/Product/Details?rowKey=${rowKey}`)
            .then(res => res.text())
            .then(html => {
                document.getElementById("productDetailContainer").innerHTML = html;
                const modal = new bootstrap.Modal(document.getElementById("productDetailModal"));
                modal.show();
            });
    }

    // Event delegation for product clicks
    container.addEventListener("click", function (e) {
        const cardBody = e.target.closest(".product-page-card-body");
        if (!cardBody) return;

        const rowKey = cardBody.getAttribute("data-rowkey");
        if (!rowKey) return;

        openProductModal(rowKey);
    });

    const sortSelect = document.getElementById("sortSelect");
    const searchInput = document.getElementById("searchInput");

    function updateProducts(url) {
        fetch(url)
            .then(res => res.text())
            .then(html => {
                container.innerHTML = html;
            });
    }

    // Sort
    sortSelect.addEventListener("change", function () {
        const sortType = this.value;
        const query = searchInput.value;
        updateProducts(`/Product/Sort?sortType=${sortType}&q=${encodeURIComponent(query)}`);
    });

    // Search
    searchInput.addEventListener("keyup", function () {
        const query = this.value;
        updateProducts(`/Product/Search?q=${encodeURIComponent(query)}`);
    });
});

</script>

@section Scripts {
    <script src="~/js/product.js"></script>
}